
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  
  <title>gonefuture</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="https://blog.csdn.net/weixin_35040169">
<meta property="og:type" content="website">
<meta property="og:title" content="gonefuture">
<meta property="og:url" content="http://gonefuture.top/index.html">
<meta property="og:site_name" content="gonefuture">
<meta property="og:description" content="https://blog.csdn.net/weixin_35040169">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="gonefuture">
<meta name="twitter:description" content="https://blog.csdn.net/weixin_35040169">
  
    <link rel="alternative" href="/atom.xml" title="gonefuture" type="application/atom+xml">
  
  
  <link rel="stylesheet" href="/css/style.css">
  
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
  

</head>

<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <nav id="upper-nav" class="inner">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <div class="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        
          <a id="nav-github" class="nav-icon" href="https://github.com/gonefutre"></a>
        
      </div>
    </nav>
    <div id="header-title">
      
        <h1 id="blog-title-wrap">
          <a href="/" id="blog-title">钱伟健的个人博客</a>
        </h1>
      
    </div>
    <div id="contenedor">
      <ul class="cube">
        <li class="cara">gonefuture</li>
        <li class="cara"></li>
        <li class="cara"></li>
        <li class="cara"></li>
        <li class="cara"></li>
        <li class="cara"></li>
      </ul>
    </div>
    <nav id="main-nav">
      
        <a class="main-nav-link" href="/">Home</a>
      
        <a class="main-nav-link" href="/archives">Archives</a>
      
        <a class="main-nav-link" href="/categories">categories</a>
      
        <a class="main-nav-link" href="/tags">tags</a>
      
        <a class="main-nav-link" href="/about">about</a>
      
      <a class="main-nav-link st-search-show-outputs">Search</a>
    </nav>
  </div>
</header>

    <div class="outer">
      <section id="main">
  
    <article id="post-2019-1-14-开发笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2019/01/14/2019-1-14-开发笔记/" class="article-date">
  <time datetime="2019-01-14T07:47:42.122Z" itemprop="datePublished">2019-01-14</time>
</h3>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/开发笔记/">开发笔记</a>
  </div>

  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/14/2019-1-14-开发笔记/">2019-1-14-开发笔记 Executors.newSingleThreadScheduledExecutor</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h1 id="Executors-newSingleThreadScheduledExecutor异常后执行停止，不显示任何报错信息"><a href="#Executors-newSingleThreadScheduledExecutor异常后执行停止，不显示任何报错信息" class="headerlink" title="Executors.newSingleThreadScheduledExecutor异常后执行停止，不显示任何报错信息"></a>Executors.newSingleThreadScheduledExecutor异常后执行停止，不显示任何报错信息</h1><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>使用newSingleThreadScheduledExecutor作为场景执行器执行任务时，发现客户端没有返回数据，后端日志也没有显示任何异常。</p>
<p>于是，在调用的方法每个阶段打印前调用打log，发现方法执行到一个阶段就停止打印了。</p>
<p>拍卖行竞拍的代码，执行时log只打印 1.</p>
<pre><code class="java">    /**
     *  竞拍物品
     * @param player 玩家
     * @param auctionItem  拍卖品
     * @param price 出价
     */
    private void bidAuctionItem(Player player, AuctionItem auctionItem, int price) {
        log.debug(&quot;1&quot;);
        Integer auctionMoney = auctionItem.getBiddersMap().get(player.getId());
        log.debug(&quot;2&quot;);
        if (Objects.isNull(auctionMoney)) {
            //  第一次竞拍
            auctionItem.addBidder(player,price);
            player.moneyChange(price);
        } else {
            auctionItem.addBidder(player,price);
            // 减去继续竞的差价
            player.moneyChange(-(price-auctionItem.getAuctionPrice()));
        }
        log.debug(&quot;3&quot;);
        notificationManager.notifyPlayer(player,MessageFormat.format(&quot;叫价功成。当前拍卖品价格是{0}&quot;,
                auctionItem.getAuctionPrice()));
        log.debug(&quot;4&quot;);
    }
</code></pre>
<p>执行这个方法的线程是一个场景执行器，</p>
<pre><code class="java">
    private static ThreadFactory sceneThreadFactory = new ThreadFactoryBuilder()
            .setNameFormat(&quot;scene-loop-%d&quot;).build();
    /** 通过一个场景一个线程处理器的方法保证每个场景的指令循序 */
    ExecutorService singleThreadSchedule = Executors.newSingleThreadScheduledExecutor(sceneThreadFactory);

</code></pre>
<p>场景执行器开始执行任务的代码。</p>
<pre><code class="java">    // 玩家在场景内则用场景的执行器执行
    Optional.ofNullable(player).map(Player::getCurrentScene).ifPresent(
        scene -&gt; scene.getSingleThreadSchedule().execute(
                () -&gt; controller.handle(ctx,msg))
    );

</code></pre>
<h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>在网上查询后发现，在JDK的源码，在源码的Java doc中的发现了如下一句话：</p>
<blockquote>
<p>If any execution of the task encounters an exception, subsequent executions are suppressed.Otherwise, the task will only terminate via cancellation or termination of the executor.</p>
</blockquote>
<p>也就是说：</p>
<blockquote>
<p>如果定时任务执行过程中遇到发生异常，则后面的任务将不再执行。</p>
</blockquote>
<p>而且，异常也不会被捕获并打印信息。</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>我的解决方式是直接在执行任务时使用try/catch。</p>
<pre><code class="java">    // 玩家在场景内则用场景的执行器执行
    Optional.ofNullable(player).map(Player::getCurrentScene).ifPresent(
        scene -&gt; scene.getSingleThreadSchedule().execute(
                () -&gt; {
                    log.debug(&quot;{}  {} 的 {} 在执行命令 {}&quot;,scene.getSingleThreadSchedule(),
                            scene.getName(),player.getName(),new String(msg.getContent()));
                    try {
                        controller.handle(ctx,msg);
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
        })
    );
</code></pre>
<p>报错信息终于显示出来了。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>这个问题折腾了我好久，方法执行到一半不执行我就猜测是出现了异常，但是异常没有被捕获。这件事教训我以后使用ExecutorService的实现类都要注意异常处理。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

        <a data-url="http://gonefuture.top/2019/01/14/2019-1-14-开发笔记/" data-id="cjqw29er40000acvtywimnm0h" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>

<!--PC和WAP自适应版-->
<div id="SOHUCS" sid="2019-1-14-开发笔记" ></div> 
<script type="text/javascript"> 
(function(){ 
var appid = 'cytLwvbWT'; 
var conf = 'prod_c2be45ba4993cf83be33cabf34204da1'; 
var width = window.innerWidth || document.documentElement.clientWidth; 
if (width < 960) { 
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>

  </div>
  
</article>





  
    <article id="post-Netty消息分发和业务逻辑分离" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2018/09/20/Netty消息分发和业务逻辑分离/" class="article-date">
  <time datetime="2018-09-20T10:27:36.909Z" itemprop="datePublished">2018-09-20</time>
</h3>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/游戏开发/">游戏开发</a>
  </div>

  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/09/20/Netty消息分发和业务逻辑分离/">Netty消息分发和业务逻辑分离</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h1 id="Netty消息分发和业务逻辑分离"><a href="#Netty消息分发和业务逻辑分离" class="headerlink" title="Netty消息分发和业务逻辑分离"></a>Netty消息分发和业务逻辑分离</h1><hr>
<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2>
      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Netty/">Netty</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringBoot/">SpringBoot</a></li></ul>

        <a data-url="http://gonefuture.top/2018/09/20/Netty消息分发和业务逻辑分离/" data-id="cjqw29erm000bacvtaran6otf" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>

<!--PC和WAP自适应版-->
<div id="SOHUCS" sid="Netty消息分发和业务逻辑分离" ></div> 
<script type="text/javascript"> 
(function(){ 
var appid = 'cytLwvbWT'; 
var conf = 'prod_c2be45ba4993cf83be33cabf34204da1'; 
var width = window.innerWidth || document.documentElement.clientWidth; 
if (width < 960) { 
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>

  </div>
  
</article>





  
    <article id="post-Netty, SpringBoot, MyBatis搭建游戏服务器 - 1" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2018/09/19/Netty, SpringBoot, MyBatis搭建游戏服务器 - 1/" class="article-date">
  <time datetime="2018-09-19T08:59:43.264Z" itemprop="datePublished">2018-09-19</time>
</h3>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/游戏开发/">游戏开发</a>
  </div>

  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/09/19/Netty, SpringBoot, MyBatis搭建游戏服务器 - 1/">Netty, SpringBoot, MyBatis搭建游戏服务器 - 1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
        <h1 id="Netty-SpringBoot-MyBatis搭建游戏服务器-1"><a href="#Netty-SpringBoot-MyBatis搭建游戏服务器-1" class="headerlink" title="Netty, SpringBoot, MyBatis搭建游戏服务器 - 1"></a>Netty, SpringBoot, MyBatis搭建游戏服务器 - 1</h1><hr>
<h2 id="各框架简介"><a href="#各框架简介" class="headerlink" title="各框架简介"></a>各框架简介</h2><p>Netty是步的、事件驱动的网络应用程序框架和工具，,很适合做游戏服务器。</p>
<p>使用SpringBoot可以抛弃传统Spirng框架的繁琐配置和依赖版本管理，更方便地打包与部署。这里我们主要是使用SpringBoot的依赖注入功能。</p>
<p>MyBatis 是一款优秀的持久层框架，它支持定制化 SQL、存储过程以及高级映射。因为我们的数据库可能因为业务需求不断地变化，所以我们可以用MyBaits的逆向工程实时根据数据库的表生成实体类、Mapper接口，Mapper  XML。或者利用注解注解写SQL语句查询。</p>
<hr>
<h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>我们要使用Netty构建一个游戏服务端，她可以接受客户端的信息，并根据业务逻辑做出响应。<br><img src="https://img-blog.csdn.net/20180919161809161?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8zNTA0MDE2OQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="架构图"></p>
<p>Spring负责依赖注入，管理对象（游戏业务对象另外由缓存模块管理），使得项目代码直之间解耦合。</p>
<p>MyBatis负责依据业务需求持久化各类数据。</p>
<hr>
<h2 id="依赖配置"><a href="#依赖配置" class="headerlink" title="依赖配置"></a>依赖配置</h2><p>项目使用Maven来管理依赖，依赖结构初步想法是</p>
<ul>
<li>mmorpg<ul>
<li>gameserver<ul>
<li>mysql</li>
<li>缓存模块</li>
<li>游戏配置管理模块</li>
<li>….</li>
</ul>
</li>
<li>gameclient</li>
</ul>
</li>
</ul>
<p>下面是当前版本项目的pom文件</p>
<p>总项目定义文件</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;com.wan37&lt;/groupId&gt;
    &lt;artifactId&gt;mmorpg&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;packaging&gt;pom&lt;/packaging&gt;

    &lt;name&gt;mmorpg&lt;/name&gt;
    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;

    &lt;modules&gt;
        &lt;module&gt;gameserver&lt;/module&gt;
        &lt;module&gt;mysql&lt;/module&gt;
    &lt;/modules&gt;

    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.0.5.RELEASE&lt;/version&gt;
        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
    &lt;/parent&gt;

    &lt;properties&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;!--&lt;dependency&gt;--&gt;
            &lt;!--&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;--&gt;
            &lt;!--&lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;--&gt;
        &lt;!--&lt;/dependency&gt;--&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-configuration-processor&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

    &lt;repositories&gt;
        &lt;repository&gt;
            &lt;id&gt;spring-snapshots&lt;/id&gt;
            &lt;name&gt;Spring Snapshots&lt;/name&gt;
            &lt;url&gt;https://repo.spring.io/snapshot&lt;/url&gt;
            &lt;snapshots&gt;
                &lt;enabled&gt;true&lt;/enabled&gt;
            &lt;/snapshots&gt;
        &lt;/repository&gt;
        &lt;repository&gt;
            &lt;id&gt;spring-milestones&lt;/id&gt;
            &lt;name&gt;Spring Milestones&lt;/name&gt;
            &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt;
            &lt;snapshots&gt;
                &lt;enabled&gt;false&lt;/enabled&gt;
            &lt;/snapshots&gt;
        &lt;/repository&gt;
    &lt;/repositories&gt;

    &lt;pluginRepositories&gt;
        &lt;pluginRepository&gt;
            &lt;id&gt;spring-snapshots&lt;/id&gt;
            &lt;name&gt;Spring Snapshots&lt;/name&gt;
            &lt;url&gt;https://repo.spring.io/snapshot&lt;/url&gt;
            &lt;snapshots&gt;
                &lt;enabled&gt;true&lt;/enabled&gt;
            &lt;/snapshots&gt;
        &lt;/pluginRepository&gt;
        &lt;pluginRepository&gt;
            &lt;id&gt;spring-milestones&lt;/id&gt;
            &lt;name&gt;Spring Milestones&lt;/name&gt;
            &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt;
            &lt;snapshots&gt;
                &lt;enabled&gt;false&lt;/enabled&gt;
            &lt;/snapshots&gt;
        &lt;/pluginRepository&gt;
    &lt;/pluginRepositories&gt;
&lt;/project&gt;

</code></pre>
<p>持久化模块定义文件</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;mmorpg&lt;/artifactId&gt;
        &lt;groupId&gt;com.wan37&lt;/groupId&gt;
        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;artifactId&gt;mysql&lt;/artifactId&gt;
    &lt;packaging&gt;jar&lt;/packaging&gt;


    &lt;dependencies&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;1.3.2&lt;/version&gt;
        &lt;/dependency&gt;


        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;!-- https://mvnrepository.com/artifact/com.alibaba/druid --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;druid&lt;/artifactId&gt;
            &lt;version&gt;1.0.26&lt;/version&gt;
        &lt;/dependency&gt;


        &lt;!-- 分页插件 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;
            &lt;artifactId&gt;pagehelper&lt;/artifactId&gt;
            &lt;version&gt;4.1.6&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!--Json Support--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;
            &lt;version&gt;1.1.43&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!--mybatis逆向工程--&gt;
        &lt;!--&lt;dependency&gt;--&gt;
            &lt;!--&lt;groupId&gt;org.mybatis.generator&lt;/groupId&gt;--&gt;
            &lt;!--&lt;artifactId&gt;mybatis-generator-core&lt;/artifactId&gt;--&gt;
            &lt;!--&lt;version&gt;1.3.2&lt;/version&gt;--&gt;
        &lt;!--&lt;/dependency&gt;--&gt;

    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;

            &lt;!--mybatis插件--&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.mybatis.generator&lt;/groupId&gt;
                &lt;artifactId&gt;mybatis-generator-maven-plugin&lt;/artifactId&gt;
                &lt;version&gt;1.3.2&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;configurationFile&gt;src\main\resources\mybatis\generatorConfig.xml&lt;/configurationFile&gt;
                    &lt;!--允许移动生成的文件--&gt;
                    &lt;verbose&gt;true&lt;/verbose&gt;
                    &lt;!--允许覆盖生成的文件--&gt;
                    &lt;overwrite&gt;true&lt;/overwrite&gt;
                &lt;/configuration&gt;
                &lt;executions&gt;
                    &lt;execution&gt;
                        &lt;id&gt;GenerateMyBatis Artifacts&lt;/id&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;generate&lt;/goal&gt;
                        &lt;/goals&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
                &lt;dependencies&gt;
                    &lt;dependency&gt;
                        &lt;groupId&gt;org.mybatis.generator&lt;/groupId&gt;
                        &lt;artifactId&gt;mybatis-generator-core&lt;/artifactId&gt;
                        &lt;version&gt;1.3.2&lt;/version&gt;
                    &lt;/dependency&gt;
                &lt;/dependencies&gt;
            &lt;/plugin&gt;

        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;
</code></pre>
<p>服务端模块</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;


    &lt;parent&gt;
        &lt;artifactId&gt;mmorpg&lt;/artifactId&gt;
        &lt;groupId&gt;com.wan37&lt;/groupId&gt;
        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;



    &lt;artifactId&gt;gameserver&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;packaging&gt;jar&lt;/packaging&gt;

    &lt;name&gt;gameserver&lt;/name&gt;
    &lt;description&gt;A game server project for Spring Boot&lt;/description&gt;


    &lt;properties&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;

    &lt;dependencies&gt;
        &lt;!-- Netty --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.netty&lt;/groupId&gt;
            &lt;artifactId&gt;netty-all&lt;/artifactId&gt;
            &lt;version&gt;4.1.29.Final&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- 引用基于MySQL和--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.wan37&lt;/groupId&gt;
            &lt;artifactId&gt;mysql&lt;/artifactId&gt;
            &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
        &lt;/dependency&gt;

    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;

</code></pre>
<hr>
<h2 id="Spring和myBatis的配置文件"><a href="#Spring和myBatis的配置文件" class="headerlink" title="Spring和myBatis的配置文件"></a>Spring和myBatis的配置文件</h2><p>gameserver模块中的application.yml</p>
<pre><code class="yml">spring:
  datasource:
    url: jdbc:mysql://localhost:3306/game?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true
    username: root
    password: 123456
    driver-class-name: com.mysql.jdbc.Driver
    type: com.alibaba.druid.pool.DruidDataSource

mybatis:
  mapper-locations: classpath*:mapper/*.xml
  check-config-location: true
  type-aliases-package: com.wan37.mysql.pojo.entity

debug: true
</code></pre>
<p>MyBitis配置类（分页助手不知是否能用到）</p>
<pre><code>package com.wan37.gameServer.config;

import com.github.pagehelper.PageHelper;
import org.mybatis.spring.annotation.MapperScan;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.Properties;


/**
 * @author 钱伟健 gonefutre
 * @date 2017/9/12 22:27.
 * @E-mail gonefuture@qq.com
 */

/*
 * 注册MyBatis分页插件PageHelper
 */

@Configuration
@MapperScan(basePackages = {&quot;com.wan37&quot;})
public class MybatisConfig {

    @Bean
    public PageHelper pageHelper() {
        System.out.println(&quot;MyBatisConfiguration.pageHelper()&quot;);
        PageHelper pageHelper = new PageHelper();
        Properties p = new Properties();
        p.setProperty(&quot;offsetAsPageNum&quot;, &quot;true&quot;);
        p.setProperty(&quot;rowBoundsWithCount&quot;, &quot;true&quot;);
        p.setProperty(&quot;reasonable&quot;, &quot;true&quot;);
        pageHelper.setProperties(p);
        return pageHelper;
    }
}
</code></pre><p>MyBatis逆向工程文件</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE generatorConfiguration PUBLIC &quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;
        &quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot; &gt;
&lt;generatorConfiguration &gt;
    &lt;!-- 引入配置文件 --&gt;
    &lt;!--     &lt;properties resource=&quot;db.properties&quot;/&gt; --&gt;
    &lt;!-- 指定数据连接驱动jar地址 --&gt;
    &lt;classPathEntry location=&quot;C:\project\mmorpg\mysql\mysql-connector-java-5.1.47.jar&quot;/&gt;
    &lt;!-- 一个数据库一个context --&gt;
    &lt;context id=&quot;msql&quot; targetRuntime=&quot;MyBatis3&quot; &gt;

        &lt;!-- generate entity时，生成hashcode和equals方法 --&gt;
        &lt;!--&lt;plugin type=&quot;org.mybatis.generator.plugins.EqualsHashCodePlugin&quot; /&gt;--&gt;
        &lt;!-- generate entity时，生成serialVersionUID --&gt;
        &lt;plugin type=&quot;org.mybatis.generator.plugins.SerializablePlugin&quot; /&gt;
        &lt;!-- 这个插件只会增加字符串字段映射到一个JDBC字符的方法 --&gt;
        &lt;!--&lt;plugin type=&quot;org.mybatis.generator.plugins.CaseInsensitiveLikePlugin&quot; /&gt;--&gt;
        &lt;!-- genenat entity时,生成toString --&gt;
        &lt;plugin type=&quot;org.mybatis.generator.plugins.ToStringPlugin&quot; /&gt;


        &lt;!-- 注释 --&gt;
        &lt;commentGenerator&gt;
            &lt;property name=&quot;suppressAllComments&quot; value=&quot;true&quot;/&gt;&lt;!-- 是否取消注释 --&gt;
            &lt;property name=&quot;supperssDate&quot; value=&quot;false&quot;/&gt;&lt;!-- 是否生成注释代码时间戳 --&gt;
        &lt;/commentGenerator&gt;
        &lt;!-- jdbc连接 --&gt;
        &lt;jdbcConnection driverClass=&quot;com.mysql.jdbc.Driver&quot;
                        connectionURL=&quot;jdbc:mysql://localhost:3306/game&quot;
                        userId=&quot;root&quot;
                        password=&quot;123456&quot; /&gt;
        &lt;!-- 类型转换 --&gt;
        &lt;javaTypeResolver&gt;
            &lt;!-- 是否使用bigDecimals,false可自动转化以下类型(Long,Integer,Short,ets..) --&gt;
            &lt;property name=&quot;forceBigDecimals&quot; value=&quot;false&quot;/&gt;
        &lt;/javaTypeResolver&gt;
        &lt;!-- 生成实体类地址 --&gt;
        &lt;javaModelGenerator targetPackage=&quot;com.wan37.mysql.pojo.entity&quot; targetProject=&quot;src/main/java&quot;&gt;
            &lt;!-- 是否在当前路径下新加一层schema,eg:
            fase路径：com.sky.ssm.po ； true路径：com.sky.ssm.po.[shemaName]
             --&gt;
            &lt;property name=&quot;enableSubPackages&quot; value=&quot;true&quot;/&gt;
            &lt;!-- 是否针对string类型的字段在set的时候进行trim调用 --&gt;
            &lt;property name=&quot;trimStrings&quot; value=&quot;true&quot;/&gt;
        &lt;/javaModelGenerator&gt;

        &lt;!-- 生成mapxml文件 --&gt;
        &lt;sqlMapGenerator targetPackage=&quot;mapper&quot; targetProject=&quot;src/main/resources&quot;&gt;
            &lt;!-- 是否在当前路径下新加一层schema,eg:
            fase路径：com.sky.ssm.mapper ； true路径：com.sky.ssm.mapper.[shemaName]
             --&gt;
            &lt;property name=&quot;enableSubPackages&quot; value=&quot;true&quot;/&gt;
        &lt;/sqlMapGenerator&gt;
        &lt;!-- 生成mapxml对应client，也就是接口dao --&gt;
        &lt;javaClientGenerator targetPackage=&quot;com.wan37.mysql.pojo.mapper&quot; targetProject=&quot;src/main/java&quot;
                             type=&quot;XMLMAPPER&quot; &gt;
            &lt;!-- 是否在当前路径下新加一层schema,eg:
            fase路径：com.sky.ssm.mapper ； true路径：com.sky.ssm.mapper.[shemaName]
             --&gt;
            &lt;property name=&quot;enableSubPackages&quot; value=&quot;true&quot;/&gt;
        &lt;/javaClientGenerator&gt;
        &lt;!-- 配置表信息 --&gt;
        &lt;!-- schema即为数据库名； tableName为对应的数据库表 ；domainObjectName是要生成的实体类 ；enable*ByExample是否生成 example类 --&gt;
        &lt;!-- &lt;table schema=&quot;store&quot; tableName=&quot;user&quot;
            domainObjectName=&quot;User&quot; enableCountByExample=&quot;true&quot;
            enableDeleteByExample=&quot;true&quot; enableSelectByExample=&quot;true&quot;
            enableUpdateByExample=&quot;ture&quot;&gt;
            忽略列，不生成bean字段
             &lt;ignoreColumn column=&quot;FRED&quot;/&gt;
                 指定列的java数据类型
           &lt;columnOverride column=&quot;PRICE&quot; javaType=&quot;double&quot; /&gt;
          &lt;/table&gt; --&gt;
        &lt;!-- 指定数据库表，要生成哪些表，就写哪些表，要和数据库中对应，不能写错！ --&gt;
        &lt;table tableName=&quot;game_role&quot;/&gt;
        &lt;table tableName=&quot;player&quot;/&gt;
        &lt;table tableName=&quot;player_roles&quot;/&gt;

    &lt;/context&gt;
&lt;/generatorConfiguration&gt;
</code></pre>
<h2 id="整合Netty"><a href="#整合Netty" class="headerlink" title="整合Netty"></a>整合Netty</h2><p>我使用的办法是把Netty服务的Handler，启动类都都变成由Spring管理的类。通过在类定义上加@Component注解，SpringBoot启动时会自动扫描注解并将Bean注入到容器中。使用   @PostConstruct修饰启动方法来启动Netty服务。</p>
<pre><code class="java">import com.wan37.gameServer.server.handler.ServerHandler;
import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.*;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import javax.annotation.PostConstruct;
import javax.annotation.Resource;


/**
 * @author gonefuture  gonefuture@qq.com
 * time 2018/9/10 11:36
 * @version 1.00
 * Description: 游戏服务端
 */
@Slf4j
@Component
@ChannelHandler.Sharable
public class GameServer {

    @Resource
    private ServerHandler serverHandler;

    //绑定端口
    private void bind(int port) throws Exception {
        // 逻辑线程组
        EventLoopGroup bossGroup = new NioEventLoopGroup();
        // 工作线程
        EventLoopGroup workGroup = new NioEventLoopGroup();

        ServerBootstrap bootstrap = new ServerBootstrap(); // 启动器
        bootstrap.group(bossGroup, workGroup)
                .channel(NioServerSocketChannel.class)
                .option(ChannelOption.SO_BACKLOG, 1024) // 最大客户端连接数为1024
                //是否启用心跳保活机制
                .childOption(ChannelOption.SO_KEEPALIVE, true)
        .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {

            @Override
            protected void initChannel(SocketChannel ch) throws Exception {
                // 这里添加业务处理handler
                ch.pipeline().addLast( serverHandler);
            }
        });

        try {
            ChannelFuture future = bootstrap.bind(port).sync();
            if (future.isSuccess()) {
                System.out.println(&quot;Server starts success at port:&quot;+port);
            }
            future.channel().closeFuture().sync();
        } catch (Exception e) {
            throw new RuntimeException(e);
        } finally {
            bossGroup.shutdownGracefully();
            workGroup.shutdownGracefully();
        }
    }

    public static void main(String[] args) throws Exception {
        int port = 8000;
        new GameServer().bind(port);
    }


    @PostConstruct
    public void start() {
        int port = 8000;
        try {
          bind(port);
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }

}

</code></pre>
<h2 id="期间遇到的各种问题"><a href="#期间遇到的各种问题" class="headerlink" title="期间遇到的各种问题"></a>期间遇到的各种问题</h2><p>整合的时候遇到过很多问题</p>
<ol>
<li>整合Netty时，由于使用new关键字创建Handler实例，导致在Handle中装配的服务实例为空，不能使用。</li>
<li>MyBatis配置类写在了mysql模块而没有写在gameserver模块,导致mapper文件扫描不到。</li>
<li>逆向工程时产生了同名的mapper xml文件未及时删除，导致出现mapper result map 重复的错误。</li>
</ol>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>当前只整合了持久化模块，接下来还要编写请求分发的部分和整合缓存模块。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MyBatis/">MyBatis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Netty/">Netty</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringBoot/">SpringBoot</a></li></ul>

        <a data-url="http://gonefuture.top/2018/09/19/Netty, SpringBoot, MyBatis搭建游戏服务器 - 1/" data-id="cjqw29erg0005acvta57c08xb" class="article-share-link">Share</a>
        
      </div>
    </footer>
  </div>
  </div>

<!--PC和WAP自适应版-->
<div id="SOHUCS" sid="Netty, SpringBoot, MyBatis搭建游戏服务器 - 1" ></div> 
<script type="text/javascript"> 
(function(){ 
var appid = 'cytLwvbWT'; 
var conf = 'prod_c2be45ba4993cf83be33cabf34204da1'; 
var width = window.innerWidth || document.documentElement.clientWidth; 
if (width < 960) { 
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>

  </div>
  
</article>





  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/01/14/2019-1-14-开发笔记/">2019-1-14-开发笔记 Executors.newSingleThreadScheduledExecutor</a>
          </li>
        
          <li>
            <a href="/2018/09/20/Netty消息分发和业务逻辑分离/">Netty消息分发和业务逻辑分离</a>
          </li>
        
          <li>
            <a href="/2018/09/19/Netty, SpringBoot, MyBatis搭建游戏服务器 - 1/">Netty, SpringBoot, MyBatis搭建游戏服务器 - 1</a>
          </li>
        
          <li>
            <a href="/2018/09/12/《Netty实战》-第五章-ByteBuf/">《Netty实战》-第五章-ByteBuf</a>
          </li>
        
          <li>
            <a href="/2018/09/11/游戏开发-基于netty的文字冒险游戏-1/">游戏开发-基于netty的冒险游戏-1</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/">MyBatis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NIO/">NIO</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/">Netty</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/">SpringBoot</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/expression/">expression</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">26</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netty/">netty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/大数据/">大数据</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/游戏开发/">游戏开发</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">24</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">11</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="100%" height="450" src="//music.163.com/outchain/player?type=0&id=472116048&auto=1&height=430"></iframe>
  </div>




  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 WeiJian Qian
	  <span id="busuanzi_container_site_pv">
		 <span id="busuanzi_value_site_pv"></span>hits
    </span><br>
    <a href="http://www.miibeian.gov.cn/" target="_blank">粤ICP备17094722号-1</a> 

      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/sun11/hexo-theme-paperbox" target="_blank">Paperbox</a>
    </div>
  </div>
  <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">categories</a>
  
    <a href="/tags" class="mobile-nav-link">tags</a>
  
    <a href="/about" class="mobile-nav-link">about</a>
  
  <a href="#search" class="mobile-nav-link st-search-show-outputs">Search</a>
</nav>
  

<!-- totop start -->
<div id="totop">
	<a title="To Top"></a>
</div>
<!-- totop end -->

<!-- swiftype search start -->

<!-- swiftype search end -->



<!-- <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> -->
<script src="//db101.cn/file/js/jquery.min.js"></script>
<script src="//db101.cn/file/js/jquery.qrcode.min.js">
<!-- <script src="//cdnjs.cloudflare.com/ajax/libs/lrsjng.jquery-qrcode/0.12.0/jquery.qrcode.min.js"></script> -->


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

</div>
</body>
</html>
